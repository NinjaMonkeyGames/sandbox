<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Markdown Builder (Default Dark)</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { 
            --primary: #2563eb; --bg: #0f172a; --text: #f1f5f9; --toolbar-bg: #020617; 
            --pane-bg: #1e293b; --label-bg: #334155; --border: #475569; 
            --item-bg: #1e293b; --input-bg: #0f172a; --line-numbers-bg: #1e293b; --line-numbers-text: #94a3b8;
        }

        body.light-mode {
            --bg: #f8fafc; --text: #1e293b; --toolbar-bg: #1e293b; --pane-bg: #ffffff;
            --label-bg: #e2e8f0; --border: #cbd5e1; --item-bg: #ffffff; --input-bg: #ffffff;
            --line-numbers-bg: #f1f5f9; --line-numbers-text: #64748b;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: background 0.2s; }
        
        .toolbar { background: var(--toolbar-bg); padding: 12px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .group { display: flex; gap: 2px; background: #334155; padding: 4px; border-radius: 6px; align-items: center; }
        .main-title-input { background: #0f172a; color: #38bdf8; border: 1px solid #334155; padding: 6px 12px; border-radius: 4px; font-weight: bold; width: 250px; outline: none; text-transform: uppercase; }
        button { border: none; background: #f1f5f9; color: #0f172a; padding: 6px 10px; cursor: pointer; border-radius: 4px; font-weight: 600; font-size: 13px; }
        button:hover { background: var(--primary); color: white; }
        .lock-container { color: white; font-size: 12px; display: flex; align-items: center; gap: 5px; margin-left: 10px; border-left: 1px solid #475569; padding-left: 15px; }

        .main { display: flex; flex: 1; overflow: hidden; }
        .pane { flex: 1; display: flex; flex-direction: column; background: var(--pane-bg); border-right: 1px solid var(--border); overflow: hidden; }
        .label { background: var(--label-bg); padding: 6px 15px; font-size: 11px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }

        .viewport { display: flex; flex: 1; overflow: hidden; background: var(--input-bg); }
        .line-numbers { width: 45px; padding: 20px 0; text-align: right; background: var(--line-numbers-bg); color: var(--line-numbers-text); font-family: 'Fira Code', monospace; font-size: 14px; line-height: 1.5; border-right: 2px solid var(--border); overflow: hidden; flex-shrink: 0; }
        .line-numbers span { display: block; padding-right: 10px; }

        .editor-wrapper { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        #editor-title-display { padding: 20px 20px 0; font-family: 'Fira Code', monospace; font-size: 24px; font-weight: bold; color: var(--primary); background: var(--input-bg); text-transform: uppercase; }
        textarea, .preview { flex: 1; padding: 10px 20px; border: none; outline: none; font-family: 'Fira Code', monospace; font-size: 14px; line-height: 1.5; background: transparent; color: var(--text); overflow-y: auto; }
        
        .preview h1 { text-transform: uppercase; }
        .preview-item { position: relative; margin-bottom: 15px; padding: 15px; border: 1px solid var(--border); border-radius: 8px; background: var(--item-bg); }
        .preview-controls { position: absolute; top: -10px; right: 10px; display: none; gap: 5px; z-index: 20; }
        .preview-item:hover .preview-controls { display: flex; }
        .gui-btn { width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); background: var(--label-bg); color: var(--text); }

        .preview pre { background: #1e1e1e; color: #dcdcdc; padding: 15px; border-radius: 6px; overflow-x: auto; }
        .preview table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        .preview th, .preview td { border: 1px solid var(--border); padding: 8px; text-align: left; }
        .preview hr { border: 0; border-top: 2px solid var(--border); margin: 20px 0; }

        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--item-bg); padding: 25px; border-radius: 12px; z-index: 100; width: 450px; border: 1px solid var(--border); box-shadow: 0 20px 40px rgba(0,0,0,0.3); color: var(--text); }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 99; backdrop-filter: blur(2px); }
        .wide-text, select, .modal input[type="text"] { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 15px; background: var(--input-bg); color: var(--text); box-sizing: border-box; }
    </style>
</head>
<body class="dark-mode">

<div class="modal-overlay" id="overlay" onclick="closeModals()"></div>

<div id="calloutModal" class="modal">
    <h3>Insert Callout</h3>
    <select id="calloutType">
        <option value="‚ÑπÔ∏è  ">Info ‚ÑπÔ∏è</option>
        <option value="üí°  ">Tip üí°</option>
        <option value="‚ö†Ô∏è  ">Caution ‚ö†Ô∏è</option>
        <option value="üö®  ">Warning üö®</option>
    </select>
    <input type="text" id="calloutText" placeholder="Enter message here...">
    <div style="text-align:right;">
        <button onclick="closeModals()">Cancel</button> 
        <button onclick="insertCalloutFinal()" style="background:var(--primary); color:white">Insert</button>
    </div>
</div>

<div class="toolbar">
    <input type="text" id="mainTitle" class="main-title-input" placeholder="Main Title (H1)" oninput="handleInput()">
    <div class="group">
        <button onclick="openModal('headerModal')">H#</button>
        <button onclick="insert('**', '**')">B</button>
        <button onclick="insert('*', '*')">I</button>
        <button onclick="insert('~~', '~~')">abc</button>
        <button onclick="insert('`', '`')">` `</button>
        <button onclick="openModal('codeModal')">[ { } ]</button>
    </div>
    <div class="group">
        <button onclick="openListModal('-')">- List</button>
        <button onclick="openListModal('1.')">1. List</button>
        <button onclick="openListModal('checkbox')">‚òë Check</button>
        <button onclick="openModal('tableModal', updateGridUI)">Áî∞ Table</button>
        <button onclick="openModal('imageModal')">üñº Img</button>
        <button onclick="openModal('linkModal')">üîó Link</button>
        <button onclick="openAnchorModal()">‚öì Anchor</button>
        <button onclick="openModal('calloutModal')" title="Insert Callout">üì¢ Callout</button>
        <button onclick="insert('\n\n---\n\n', '')">‚Åù Break</button>
        <button onclick="insertTOC()" style="background:#8b5cf6; color:white;">üìã TOC</button>
        <button onclick="insert('\n\n---\n\n[Back to Top](#top)\n\n---\n\n', '')">üîù Top</button>
    </div>
    <button onclick="toggleTheme()" class="theme-btn" id="themeBtn">‚òÄÔ∏è Light Mode</button>
    <div class="lock-container"><input type="checkbox" id="lockEditor" onchange="toggleLock()"><label for="lockEditor">Lock</label></div>
    <div style="margin-left:auto; display:flex; gap:5px;">
        <button onclick="clearAll()" style="background:#ef4444; color:white;">Clear</button>
        <button onclick="copyToClipboard()" style="background:#6366f1; color:white;">Copy</button>
        <button onclick="downloadMD()" style="background:#10b981; color:white;">Save</button>
    </div>
</div>

<div class="main">
    <div class="pane">
        <div class="label">Editor <span id="stats">W: 0 | C: 0</span></div>
        <div class="viewport">
            <div id="lineNumbers" class="line-numbers"></div>
            <div class="editor-wrapper">
                <div id="editor-title-display"></div>
                <textarea id="editor" spellcheck="false" oninput="handleInput()" onscroll="syncScroll('e')"></textarea>
            </div>
        </div>
    </div>
    <div class="pane">
        <div class="label">Preview (Drag to reorder)</div>
        <div class="viewport">
            <div id="previewLineNumbers" class="line-numbers"></div>
            <div id="preview" class="preview" onscroll="syncScroll('p')"></div>
        </div>
    </div>
</div>

<script>
    const editor = document.getElementById('editor'), preview = document.getElementById('preview'), 
          lineNums = document.getElementById('lineNumbers'), prevLineNums = document.getElementById('previewLineNumbers'),
          titleInput = document.getElementById('mainTitle'), titleDisplay = document.getElementById('editor-title-display'),
          overlay = document.getElementById('overlay');

    function handleInput() {
        titleDisplay.innerText = titleInput.value.trim() ? "# " + titleInput.value.trim() : "";
        updateLines();
        render();
    }

    function updateLines() {
        const count = editor.value.split('\n').length + (titleInput.value.trim() ? 2 : 0);
        const html = Array.from({length: count}, (_, i) => `<span>${i + 1}</span>`).join('');
        lineNums.innerHTML = prevLineNums.innerHTML = html;
    }

    function render() {
        const raw = editor.value;
        document.getElementById('stats').innerText = `W: ${raw.trim() ? raw.trim().split(/\s+/).length : 0} | C: ${raw.length}`;
        const blocks = raw.split(/\n\n+/);
        preview.innerHTML = titleInput.value.trim() ? `<div class="preview-item" style="border:none;background:transparent;"><h1 id="top">${titleInput.value.trim()}</h1></div>` : "";

        blocks.forEach((block, idx) => {
            if (!block.trim()) return;
            const wrap = document.createElement('div');
            wrap.className = 'preview-item'; wrap.dataset.raw = encodeURIComponent(block);
            
            let h = block
                 .replace(/^# (.*$)/gm, (m, g1) => `<h1 id="${getSlug(g1)}">${g1}</h1>`)
                 .replace(/^##+ (.*$)/gm, (m, g1) => `<h2 id="${getSlug(g1)}">${g1}</h2>`)
                 .replace(/```(\w*)\n([\s\S]*?)```/gm, '<pre><code>$2</code></pre>')
                 .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/~~(.*?)~~/g, '<del>$1</del>')
                 .replace(/\n/g, '<br>')
                 .replace(/^---$/gm, '<hr>');
            
            wrap.innerHTML = `<div class="preview-controls"><div class="gui-btn gui-drag">‚†ø</div><div class="gui-btn" style="color:red" onclick="deleteBlock(${idx})">‚úï</div></div>${h}`;
            preview.appendChild(wrap);
        });
    }

    function insertCalloutFinal() {
        const type = document.getElementById('calloutType').value;
        let text = document.getElementById('calloutText').value.trim();
        if (text) {
            text = text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
            // Printing formatted: Emoji + Double Space + **Bold Text**
            insert(`\n${type}**${text}**\n\n`, "");
            document.getElementById('calloutText').value = "";
            closeModals();
        }
    }

    function openModal(id, callback) { 
        document.getElementById(id).style.display = 'block'; 
        overlay.style.display = 'block'; 
        if(callback) callback();
        const input = document.getElementById(id).querySelector('input[type="text"]');
        if(input) setTimeout(() => input.focus(), 50);
    }
    
    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); overlay.style.display = 'none'; }
    function insert(pre, post) {
        const s = editor.selectionStart, e = editor.selectionEnd;
        editor.value = editor.value.slice(0, s) + pre + editor.value.slice(s, e) + post + editor.value.slice(e);
        handleInput();
    }

    function toggleTheme() { 
        document.body.classList.toggle('light-mode');
        document.getElementById('themeBtn').innerText = document.body.classList.contains('light-mode') ? 'üåô Dark Mode' : '‚òÄÔ∏è Light Mode';
    }
    
    function getSlug(t) { return t.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-'); }
    function deleteBlock(i) { const b = editor.value.split(/\n\n+/); b.splice(i,1); editor.value = b.join('\n\n'); handleInput(); }
    function copyToClipboard() { navigator.clipboard.writeText((titleInput.value ? `# ${titleInput.value}\n\n` : "") + editor.value); alert("Copied!"); }

    Sortable.create(preview, { handle: '.gui-drag', animation: 150, onEnd: () => {
        editor.value = Array.from(preview.querySelectorAll('.preview-item')).map(i => i.dataset.raw ? decodeURIComponent(i.dataset.raw) : "").filter(t=>t).join('\n\n');
        handleInput();
    }});

    handleInput();
</script>
</body>
</html>