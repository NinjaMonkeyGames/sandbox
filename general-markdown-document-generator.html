<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Markdown Builder (Default Dark)</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { 
            --primary: #2563eb; --bg: #0f172a; --text: #f1f5f9; --toolbar-bg: #020617; 
            --pane-bg: #1e293b; --label-bg: #334155; --border: #475569; 
            --item-bg: #1e293b; --input-bg: #0f172a; --line-numbers-bg: #1e293b; --line-numbers-text: #94a3b8;
        }

        body.light-mode {
            --bg: #f8fafc; --text: #1e293b; --toolbar-bg: #1e293b; --pane-bg: #ffffff;
            --label-bg: #e2e8f0; --border: #cbd5e1; --item-bg: #ffffff; --input-bg: #ffffff;
            --line-numbers-bg: #f1f5f9; --line-numbers-text: #64748b;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: background 0.2s; }
        
        .toolbar { background: var(--toolbar-bg); padding: 12px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .group { display: flex; gap: 2px; background: #334155; padding: 4px; border-radius: 6px; align-items: center; }
        .main-title-input { background: #0f172a; color: #38bdf8; border: 1px solid #334155; padding: 6px 12px; border-radius: 4px; font-weight: bold; width: 250px; outline: none; text-transform: uppercase; }
        button { border: none; background: #f1f5f9; color: #0f172a; padding: 6px 10px; cursor: pointer; border-radius: 4px; font-weight: 600; font-size: 13px; }
        button:hover { background: var(--primary); color: white; }
        .lock-container { color: white; font-size: 12px; display: flex; align-items: center; gap: 5px; margin-left: 10px; border-left: 1px solid #475569; padding-left: 15px; }

        .main { display: flex; flex: 1; overflow: hidden; }
        .pane { flex: 1; display: flex; flex-direction: column; background: var(--pane-bg); border-right: 1px solid var(--border); overflow: hidden; }
        .label { background: var(--label-bg); padding: 6px 15px; font-size: 11px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }

        .viewport { display: flex; flex: 1; overflow: hidden; background: var(--input-bg); }
        .line-numbers { width: 45px; padding: 20px 0; text-align: right; background: var(--line-numbers-bg); color: var(--line-numbers-text); font-family: 'Fira Code', monospace; font-size: 14px; line-height: 1.5; border-right: 2px solid var(--border); overflow: hidden; flex-shrink: 0; }
        .line-numbers span { display: block; padding-right: 10px; }

        .editor-wrapper { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        #editor-title-display { padding: 20px 20px 0; font-family: 'Fira Code', monospace; font-size: 24px; font-weight: bold; color: var(--primary); background: var(--input-bg); text-transform: uppercase; }
        textarea, .preview { flex: 1; padding: 10px 20px; border: none; outline: none; font-family: 'Fira Code', monospace; font-size: 14px; line-height: 1.5; background: transparent; color: var(--text); overflow-y: auto; }
        
        .preview h1 { text-transform: uppercase; }
        .preview-item { position: relative; margin-bottom: 15px; padding: 15px; border: 1px solid var(--border); border-radius: 8px; background: var(--item-bg); }
        .preview-controls { position: absolute; top: -10px; right: 10px; display: none; gap: 5px; z-index: 20; }
        .preview-item:hover .preview-controls { display: flex; }
        .gui-btn { width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); background: var(--label-bg); color: var(--text); }

        .preview pre { background: #1e1e1e; color: #dcdcdc; padding: 15px; border-radius: 6px; overflow-x: auto; }
        .preview table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        .preview th, .preview td { border: 1px solid var(--border); padding: 8px; text-align: left; }
        .preview hr { border: 0; border-top: 2px solid var(--border); margin: 20px 0; }

        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--item-bg); padding: 25px; border-radius: 12px; z-index: 100; width: 450px; border: 1px solid var(--border); box-shadow: 0 20px 40px rgba(0,0,0,0.3); color: var(--text); }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 99; backdrop-filter: blur(2px); }
        .grid-builder input { width: 100%; border: 1px solid var(--border); padding: 6px; background: var(--input-bg); color: var(--text); box-sizing: border-box; }
        .wide-text, select, .modal input[type="text"] { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 15px; background: var(--input-bg); color: var(--text); box-sizing: border-box; }
    </style>
</head>
<body>

<div class="modal-overlay" id="overlay" onclick="closeModals()"></div>

<div id="codeModal" class="modal"><h3>Insert Code Block</h3><select id="codeLangSelect"></select><textarea id="codeContent" class="wide-text" placeholder="Paste code here..."></textarea><div style="text-align:right;"><button onclick="closeModals()">Cancel</button> <button onclick="insertCodeFinal()" style="background:var(--primary); color:white">Insert Code</button></div></div>
<div id="tableModal" class="modal" style="width:650px;"><h3>Table Builder</h3><div style="margin-bottom:10px; display:flex; gap:8px;"><button onclick="adjustGrid(1,0)">+ Row</button><button onclick="adjustGrid(0,1)">+ Col</button><button onclick="resetGrid()" style="background:#ef4444; color:white;">Reset</button></div><div style="overflow-x:auto;"><table class="grid-builder"><thead><tr id="gridHead"></tr></thead><tbody id="gridBody"></tbody></table></div><div style="text-align:right; margin-top:15px;"><button onclick="closeModals()">Cancel</button><button onclick="insertTableFinal()" style="background:var(--primary); color:white">Insert Table</button></div></div>
<div id="linkModal" class="modal"><h3>Link</h3><input type="text" id="linkText" placeholder="Text"><input type="text" id="linkUrl" placeholder="URL"><div style="text-align:right;"><button onclick="closeModals()">Cancel</button> <button onclick="insertLinkFinal()" style="background:var(--primary); color:white">Insert</button></div></div>
<div id="anchorModal" class="modal"><h3>Anchor Link</h3><select id="anchorSelect"></select><div style="text-align:right;"><button onclick="closeModals()">Cancel</button> <button onclick="insertAnchorFinal()" style="background:var(--primary); color:white">Insert</button></div></div>
<div id="imageModal" class="modal"><h3>Image</h3><input type="text" id="imgAlt" placeholder="Alt text"><input type="text" id="imgUrl" placeholder="URL"><div style="text-align:right;"><button onclick="closeModals()">Cancel</button> <button onclick="insertImageFinal()" style="background:var(--primary); color:white">Insert</button></div></div>
<div id="listModal" class="modal"><h3>Add Items</h3><div id="listItemsContainer"></div><button onclick="addListRow()" style="background:#334155; color:white; width:100%; margin-bottom:15px; padding:8px;">+ Add Item</button><div style="text-align:right;"><button onclick="closeModals()">Cancel</button> <button id="listSubmitBtn" style="background:var(--primary); color:white">Insert</button></div></div>
<div id="headerModal" class="modal"><h3>Sub-Heading</h3><select id="headerLevel"><option value="2">H2</option><option value="3">H3</option><option value="4">H4</option></select><input type="text" id="headerText" placeholder="Heading text..."><div style="text-align:right;"><button onclick="closeModals()">Cancel</button> <button onclick="insertHeaderFinal()" style="background:var(--primary); color:white">Insert</button></div></div>

<div class="toolbar">
    <input type="text" id="mainTitle" class="main-title-input" placeholder="Main Title (H1)" oninput="handleInput()">
    <div class="group">
        <button onclick="openModal('headerModal')">H#</button>
        <button onclick="insert('**', '**')">B</button>
        <button onclick="insert('*', '*')">I</button>
        <button onclick="insert('~~', '~~')" style="text-decoration:line-through;">abc</button>
        <button onclick="insert('`', '`')">` `</button>
        <button onclick="openModal('codeModal')">[ { } ]</button>
    </div>
    <div class="group">
        <button onclick="openListModal('-')">- List</button>
        <button onclick="openListModal('1.')">1. List</button>
        <button onclick="openListModal('checkbox')">‚òë Check</button>
        <button onclick="openModal('tableModal', updateGridUI)">Áî∞ Table</button>
        <button onclick="openModal('imageModal')">üñº Img</button>
        <button onclick="openModal('linkModal')">üîó Link</button>
        <button onclick="openAnchorModal()">‚öì Anchor</button>
        <button onclick="insert('\n\n---\n\n', '')" title="Line Break">‚Åù Break</button>
        <button onclick="insertTOC()" style="background:#8b5cf6; color:white;">üìã TOC</button>
        <button onclick="insert('\n\n---\n\n[Back to Top](#top)\n\n---\n\n', '')">üîù Top</button>
    </div>
    <button onclick="toggleTheme()" class="theme-btn" id="themeBtn">‚òÄÔ∏è Light Mode</button>
    <div class="lock-container"><input type="checkbox" id="lockEditor" onchange="toggleLock()"><label for="lockEditor">Lock</label></div>
    <div style="margin-left:auto; display:flex; gap:5px;">
        <button onclick="clearAll()" style="background:#ef4444; color:white;">Clear</button>
        <button onclick="copyToClipboard()" style="background:#6366f1; color:white;">Copy</button>
        <button onclick="downloadMD()" style="background:#10b981; color:white;">Save</button>
    </div>
</div>

<div class="main">
    <div class="pane">
        <div class="label">Editor <span id="stats">W: 0 | C: 0</span></div>
        <div class="viewport">
            <div id="lineNumbers" class="line-numbers"></div>
            <div class="editor-wrapper">
                <div id="editor-title-display"></div>
                <textarea id="editor" spellcheck="false" oninput="handleInput()" onscroll="syncScroll('e')"></textarea>
            </div>
        </div>
    </div>
    <div class="pane">
        <div class="label">Preview (Drag to reorder)</div>
        <div class="viewport">
            <div id="previewLineNumbers" class="line-numbers"></div>
            <div id="preview" class="preview" onscroll="syncScroll('p')"></div>
        </div>
    </div>
</div>

<script>
    const gfm_langs = ["bash", "c", "cpp", "csharp", "css", "go", "html", "java", "javascript", "json", "python", "ruby", "rust", "sql", "typescript", "xml", "yaml"];
    const editor = document.getElementById('editor'), preview = document.getElementById('preview'), 
          lineNums = document.getElementById('lineNumbers'), prevLineNums = document.getElementById('previewLineNumbers'),
          titleInput = document.getElementById('mainTitle'), titleDisplay = document.getElementById('editor-title-display'),
          overlay = document.getElementById('overlay');

    let gridRows = 2, gridCols = 2;

    function handleInput() {
        titleDisplay.innerText = titleInput.value.trim() ? "# " + titleInput.value.trim() : "";
        updateLines();
        render();
    }

    function updateLines() {
        const count = editor.value.split('\n').length + (titleInput.value.trim() ? 2 : 0);
        const html = Array.from({length: count}, (_, i) => `<span>${i + 1}</span>`).join('');
        lineNums.innerHTML = prevLineNums.innerHTML = html;
    }

    function syncScroll(s) {
        if (s === 'e') lineNums.scrollTop = editor.scrollTop;
        else prevLineNums.scrollTop = preview.scrollTop;
    }

    function render() {
        const raw = editor.value;
        document.getElementById('stats').innerText = `W: ${raw.trim() ? raw.trim().split(/\s+/).length : 0} | C: ${raw.length}`;
        const blocks = raw.split(/\n\n+/);
        preview.innerHTML = titleInput.value.trim() ? `<div class="preview-item" style="border:none;background:transparent;"><h1 id="top">${titleInput.value.trim()}</h1></div>` : "";

        blocks.forEach((block, idx) => {
            if (!block.trim()) return;
            const wrap = document.createElement('div');
            wrap.className = 'preview-item'; wrap.dataset.raw = encodeURIComponent(block);
            
            let h = block
                         .replace(/^# (.*$)/gm, (m, g1) => `<h1 id="${getSlug(g1)}">${g1}</h1>`)
                         .replace(/^##+ (.*$)/gm, (m, g1) => `<h2 id="${getSlug(g1)}">${g1}</h2>`)
                         .replace(/```(\w*)\n([\s\S]*?)```/gm, '<pre><code>$2</code></pre>')
                         .replace(/^- \[( |x)\] (.*)/gm, '<div>‚òê $2</div>')
                         .replace(/^- (.*)/gm, '<li>$1</li>').replace(/^\d+\. (.*)/gm, '<li>$1</li>')
                         .replace(/\|(.+)\|/g, m => m.match(/^[|\s-]+$/) ? '' : '<tr>' + m.split('|').filter(c => c.trim()).map(c => `<td>${c}</td>`).join('') + '</tr>')
                         .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/~~(.*?)~~/g, '<del>$1</del>')
                         .replace(/`([^`]+)`/g, '<code>$1</code>').replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2">')
                         .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>').replace(/\n/g, '<br>')
                         .replace(/^---$/gm, '<hr>'); // Line break rendering
            
            if (h.includes('<li>')) h = `<ul>${h}</ul>`;
            if (h.includes('<tr>')) h = `<table>${h}</table>`;
            wrap.innerHTML = `<div class="preview-controls"><div class="gui-btn gui-drag">‚†ø</div><div class="gui-btn" style="color:red" onclick="deleteBlock(${idx})">‚úï</div></div>${h}`;
            preview.appendChild(wrap);
        });
    }

    function openModal(id, callback) { document.getElementById(id).style.display = 'block'; overlay.style.display = 'block'; if(callback) callback(); }
    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); overlay.style.display = 'none'; }
    function insert(pre, post, content = null) {
        const s = editor.selectionStart, e = editor.selectionEnd;
        editor.value = editor.value.slice(0, s) + pre + (content || editor.value.slice(s, e)) + post + editor.value.slice(e);
        handleInput();
    }

    function updateGridUI() {
        const h = document.getElementById('gridHead'), b = document.getElementById('gridBody');
        h.innerHTML = Array(gridCols).fill(0).map((_,i)=>`<th><input type="text" placeholder="H${i+1}" class="gh"></th>`).join('');
        b.innerHTML = Array(gridRows).fill(0).map(()=>`<tr>${Array(gridCols).fill(0).map(()=>`<td><input type="text" class="gb"></td>`).join('')}</tr>`).join('');
    }
    function adjustGrid(r, c) { gridRows += r; gridCols += c; updateGridUI(); }
    function resetGrid() { gridRows = 2; gridCols = 2; updateGridUI(); }
    function insertTableFinal() {
        const hs = Array.from(document.querySelectorAll('.gh')).map(i => i.value || " ");
        const bs = Array.from(document.querySelectorAll('.gb')).map(i => i.value || " ");
        let md = `\n| ${hs.join(' | ')} |\n| ${hs.map(()=>'---').join(' | ')} |\n`;
        for(let r=0; r<gridRows; r++) md += `| ${bs.slice(r*gridCols, (r+1)*gridCols).join(' | ')} |\n`;
        insert(md + "\n", ""); closeModals();
    }

    function insertCodeFinal() { insert(`\n\`\`\`${document.getElementById('codeLangSelect').value}\n${document.getElementById('codeContent').value}\n\`\`\`\n`, ""); closeModals(); }
    function openListModal(type) {
        document.getElementById('listItemsContainer').innerHTML = '<input type="text" class="li-in" placeholder="Item 1">';
        openModal('listModal');
        document.getElementById('listSubmitBtn').onclick = () => {
            let md = "\n";
            document.querySelectorAll('.li-in').forEach((input, i) => { if(input.value) md += (type === '1.' ? `${i+1}. ` : (type === '-' ? '- ' : '- [ ] ')) + input.value + "\n"; });
            insert(md + "\n", ""); closeModals();
        };
    }
    function addListRow() { const i = document.createElement('input'); i.className = "li-in"; i.placeholder = "Next item"; document.getElementById('listItemsContainer').appendChild(i); i.focus(); }

    function openAnchorModal() {
        const s = document.getElementById('anchorSelect'); s.innerHTML = "";
        editor.value.split('\n').forEach(l => { const m = l.match(/^##+ (.*)/); if(m) s.add(new Option(m[1].trim(), getSlug(m[1]))); });
        openModal('anchorModal');
    }
    function insertAnchorFinal() { const s = document.getElementById('anchorSelect'); insert(`[${s.options[s.selectedIndex].text}](#${s.value})`, ""); closeModals(); }
    function insertTOC() {
        let md = "## Table of Contents\n";
        editor.value.split('\n').forEach(l => { const m = l.match(/^##+ (.*)/); if(m) md += `${"  ".repeat(m[0].split('#').length-3)}- [${m[1].trim()}](#${getSlug(m[1])})\n`; });
        insert("\n" + md + "\n", "");
    }

    function getSlug(t) { return t.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-'); }
    function deleteBlock(i) { const b = editor.value.split(/\n\n+/); b.splice(i,1); editor.value = b.join('\n\n'); handleInput(); }
    
    function toggleTheme() { 
        document.body.classList.toggle('light-mode');
        const isLight = document.body.classList.contains('light-mode');
        document.getElementById('themeBtn').innerText = isLight ? 'üåô Dark Mode' : '‚òÄÔ∏è Light Mode';
    }
    
    function toggleLock() { editor.disabled = document.getElementById('lockEditor').checked; }
    function clearAll() { if(confirm("Clear everything?")) { titleInput.value = editor.value = ""; handleInput(); } }
    function copyToClipboard() { navigator.clipboard.writeText((titleInput.value ? `# ${titleInput.value}\n\n` : "") + editor.value); alert("Copied!"); }
    function downloadMD() {
        const b = new Blob([(titleInput.value ? `# ${titleInput.value}\n\n` : "") + editor.value], {type:'text/markdown'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = "doc.md"; a.click();
    }
    
    Sortable.create(preview, { handle: '.gui-drag', animation: 150, onEnd: () => {
        editor.value = Array.from(preview.querySelectorAll('.preview-item')).map(i => i.dataset.raw ? decodeURIComponent(i.dataset.raw) : "").filter(t=>t).join('\n\n');
        handleInput();
    }});

    gfm_langs.sort().forEach(l => document.getElementById('codeLangSelect').add(new Option(l, l)));
    handleInput();
</script>
</body>
</html>