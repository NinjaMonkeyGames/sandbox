# .github/workflows/staging.yaml (Logic for the develop Branch)
name: Develop Branch Staging CI/CD Workflow

on:
  workflow_call:
    secrets:
      # Secrets for deploying to the staging environment
      STAGING_SERVER_HOST:
        required: true
      STAGING_SSH_KEY:
        required: true

jobs:
  staging_deploy:
    runs-on: ubuntu-latest
    environment: staging # Assigned for the develop branch integration tasks

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Report Successful Staging Call
        run: |
          echo "###################################################"
          echo "## STAGING WORKFLOW (Develop Branch) CALLED! ##"
          echo "###################################################"
          echo "Triggered by branch: ${{ github.ref_name }}"
          echo "Executing full integration tests and deploying to STAGING."

      - name: Run Integration Tests
        run: |
          echo "Running full integration tests..."
          ./scripts/run-integration-tests.sh
          
      - name: Deploy to Staging Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_SERVER_HOST }}
          username: ${{ secrets.STAGING_SSH_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /var/www/staging
            git pull origin develop
            ./deploy.sh