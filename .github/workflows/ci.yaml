# .github/workflows/ci.yaml
name: Main CI Dispatcher
on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'

jobs:
  dispatch:
    runs-on: ubuntu-latest
    # This job determines the environment based on the branch name
    steps:
      - name: Determine Environment
        id: env_detector
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          ENVIRONMENT=""
          
          # Production (e.g., main or master branches)
          if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "master" ]]; then
            ENVIRONMENT="production"
          # Staging (e.g., staging branch or release/* branches)
          elif [[ "$BRANCH_NAME" == "staging" || "$BRANCH_NAME" == release/* ]]; then
            ENVIRONMENT="staging"
          # Development (any other branch, like feature/* or develop)
          else
            ENVIRONMENT="development"
          fi
          
          echo "Determined environment: $ENVIRONMENT"
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT

    outputs:
      environment: ${{ steps.env_detector.outputs.environment }}

  # Call the appropriate workflow based on the detected environment
  call_development:
    name: Development CI
    uses: ./.github/workflows/development.yaml
    needs: dispatch
    if: needs.dispatch.outputs.environment == 'development'
    
  call_staging:
    name: Staging CI
    uses: ./.github/workflows/staging.yaml
    needs: dispatch
    if: needs.dispatch.outputs.environment == 'staging'
    
  call_production:
    name: Production CI
    uses: ./.github/workflows/production.yaml
    needs: dispatch
    if: needs.dispatch.outputs.environment == 'production'