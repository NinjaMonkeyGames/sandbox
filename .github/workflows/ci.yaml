name: 1. Environment Detector & Dispatcher

# Trigger on pushes to all relevant GitFlow branches
on:
  push:
    branches:
      - master # Production
      - develop # Staging/UAT
      - feature/** # Development/Ephemeral
      - release/** # Pre-Production/Release Candidate
      - hotfix/** # Production Fix

jobs:
  detect_environment:
    runs-on: ubuntu-latest
    outputs:
      # Expose the detected environment name for other jobs/workflows
      environment: ${{ steps.set_env.outputs.env_name }}
      
    steps:
      - name: Set Environment Name (GitFlow Logic)
        id: set_env
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          ENVIRONMENT=""

          if [[ "$BRANCH_NAME" == "master" ]]; then
            ENVIRONMENT="production"
          elif [[ "$BRANCH_NAME" == "develop" ]]; then
            ENVIRONMENT="staging"
          elif [[ "$BRANCH_NAME" == release/* ]]; then
            ENVIRONMENT="pre-production"
          elif [[ "$BRANCH_NAME" == hotfix/* ]]; then
            ENVIRONMENT="hotfix"
          else
            # Covers feature/* branches and any others
            ENVIRONMENT="development"
          fi
          
          # 1. Echo the detected environment
          echo "--- Detected CI Environment ---"
          echo "Branch: $BRANCH_NAME"
          echo "Set Environment to: $ENVIRONMENT"
          echo "-------------------------------"
          
          # 2. Set the output variable 'env_name'
          # This line ensures the variable is available as a job output
          echo "env_name=$ENVIRONMENT" >> $GITHUB_OUTPUT
          
      - name: Echo Detected Environment Output (FIXED SYNTAX)
        # Using '|' for multi-line string prevents the "Nested mappings not allowed" error
        run: |
          echo "Environment output set: ${{ steps.set_env.outputs.env_name }}"

  # This job will call the appropriate deployment workflow
  dispatch_workflow:
    # IMPORTANT: Access outputs using the job ID: 'detect_environment'
    needs: detect_environment 
    runs-on: ubuntu-latest
    
    steps:
      - name: Workflow Dispatcher
        # Use the job output accessed via 'needs.<job-id>.outputs.<output-key>'
        run: |
          TARGET_ENV="${{ needs.detect_environment.outputs.environment }}"
          echo "Target Environment is: $TARGET_ENV"
          
          # Determine which subsequent script to "call" or "run"
          if [[ "$TARGET_ENV" == "production" ]]; then
            echo "::notice title=Workflow Dispatch::Calling deploy-production.yaml for master branch"
            # Logic for calling the production workflow
            
          elif [[ "$TARGET_ENV" == "staging" ]]; then
            echo "::notice title=Workflow Dispatch::Calling deploy-staging.yaml for develop branch"
            # Logic for calling the staging workflow
            
          else
            echo "::notice title=Workflow Dispatch::Calling generic-build.yaml for $TARGET_ENV"
            # Logic for calling the default workflow (feature/development)
          fi